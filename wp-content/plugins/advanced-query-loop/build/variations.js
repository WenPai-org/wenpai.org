var aql;(()=>{"use strict";var e={d:(t,a)=>{for(var r in a)e.o(a,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{AQL:()=>O,AQLControls:()=>i,AQLControlsInheritedQuery:()=>_});const a=window.wp.blocks,r=window.wp.i18n,l=window.React,o=window.wp.hooks,n=window.wp.blockEditor,u=window.wp.components,{Fill:d,Slot:s}=(0,u.createSlotFill)("AQLControls"),c=({children:e})=>(0,l.createElement)(d,null,e);c.Slot=({fillProps:e})=>(0,l.createElement)(s,{fillProps:e},(e=>e.length?e:null));const i=c,{Fill:y,Slot:m}=(0,u.createSlotFill)("AQLControlsInheritedQuery"),p=({children:e})=>(0,l.createElement)(y,null,e);p.Slot=m;const _=p,q=({attributes:e,setAttributes:t})=>{const{query:{perPage:a,offset:o=0}={}}=e;return(0,l.createElement)(u.RangeControl,{label:(0,r.__)("Posts Per Page","advanced-query-loop"),min:1,max:50,onChange:a=>{t({query:{...e.query,perPage:a,offset:o}})},value:a})},v=({attributes:e,setAttributes:t})=>{const{query:{offset:a=0}={}}=e;return(0,l.createElement)(u.__experimentalNumberControl,{label:(0,r.__)("Post Offset","advanced-query-loop"),value:a,min:0,onChange:a=>{t({query:{...e.query,offset:a}})}})},h={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let E;const b=new Uint8Array(16);function g(){if(!E&&(E="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!E))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return E(b)}const f=[];for(let e=0;e<256;++e)f.push((e+256).toString(16).slice(1));const w=function(e,t,a){if(h.randomUUID&&!t&&!e)return h.randomUUID();const r=(e=e||{}).random||(e.rng||g)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){a=a||0;for(let e=0;e<16;++e)t[a+e]=r[e];return t}return function(e,t=0){return(f[e[t+0]]+f[e[t+1]]+f[e[t+2]]+f[e[t+3]]+"-"+f[e[t+4]]+f[e[t+5]]+"-"+f[e[t+6]]+f[e[t+7]]+"-"+f[e[t+8]]+f[e[t+9]]+"-"+f[e[t+10]]+f[e[t+11]]+f[e[t+12]]+f[e[t+13]]+f[e[t+14]]+f[e[t+15]]).toLowerCase()}(r)},C=window.wp.coreData,S=window.wp.element,P=["=","!=",">",">=","<","<=","LIKE","NOT LIKE","IN","NOT IN","BETWEEN","NOT BETWEEN","EXISTS","NOT EXISTS","REGEXP","NOT REGEXP","RLIKE"],A=({registeredMetaKeys:e,id:t,queries:a,attributes:o,setAttributes:n})=>{const d=a.find((e=>e.id===t)),s=(e,t,a,r)=>e.map((e=>e.id===t?{...e,[a]:r}:e));return(0,l.createElement)(l.Fragment,null,(0,l.createElement)(u.BaseControl,{help:(0,r.__)("Start typing to search for a meta key or manually enter one.","advanced-query-loop")},(0,l.createElement)(u.FormTokenField,{label:(0,r.__)("Meta Key","advanced-query-loop"),value:d?.meta_key?.length?[d.meta_key]:[],__experimentalShowHowTo:!1,suggestions:e,maxLength:1,onChange:e=>{n({query:{...o.query,meta_query:{...o.query.meta_query,queries:s(a,t,"meta_key",e[0])}}})}})),(0,l.createElement)(u.TextControl,{label:(0,r.__)("Meta Value","advanced-query-loop"),value:d.meta_value,onChange:e=>{n({query:{...o.query,meta_query:{...o.query.meta_query,queries:s(a,t,"meta_value",e)}}})}}),(0,l.createElement)(u.SelectControl,{label:(0,r.__)("Meta Compare","advanced-query-loop"),value:d.meta_compare,options:[...P.map((e=>({label:e,value:e})))],onChange:e=>{n({query:{...o.query,meta_query:{...o.query.meta_query,queries:s(a,t,"meta_compare",e)}}})}}),(0,l.createElement)(u.Button,{isSmall:!0,variant:"secondary",isDestructive:!0,onClick:()=>{const e=a.filter((e=>e.id!==t));n({query:{...o.query,meta_query:{...o.query.meta_query,queries:e}}})}},(0,r.__)("Remove meta query","advanced-query-loop")))},T=({attributes:e,setAttributes:t})=>{const{query:{postType:a,meta_query:{relation:o="",queries:n=[]}={}}={}}=e,{records:d}=(0,C.useEntityRecords)("postType",a,{per_page:1}),[s]=(0,S.useState)(a),c=(e=>({...e?.[0]?.meta,...e?.[0]?.acf}))(d);return(0,S.useEffect)((()=>{a!==s&&t({query:{...e.query,include_posts:[],meta_query:{}}})}),[a]),(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null,(0,r.__)("Post Meta Query","advanced-query-loop")),(0,l.createElement)(l.Fragment,null,n.length>1&&(0,l.createElement)(u.SelectControl,{label:(0,r.__)("Query Relationship","advanced-query-loop"),value:o,options:[{label:"Choose relationship",value:""},{label:"AND",value:"AND"},{label:"OR",value:"OR"}],onChange:a=>t({query:{...e.query,meta_query:{...e.query.meta_query,relation:a}}})}),n.length<1&&(0,l.createElement)("p",null,(0,r.__)("Add a meta query to select post meta to query","advanced-query-loop")),n.map((({id:a,meta_key:r,meta_value:o,compare:d})=>(0,l.createElement)(u.PanelBody,{key:a},(0,l.createElement)(A,{id:a,metaKey:r,metaValue:o,metaCompare:d,registeredMetaKeys:Object.keys(c),queries:n,attributes:e,setAttributes:t})))),(0,l.createElement)(u.Button,{isSmall:!0,variant:"primary",onClick:()=>{const a=[...n,{id:w(),meta_key:"",meta_value:"",meta_compare:""}];t({query:{...e.query,meta_query:{...e.query.meta_query,queries:a}}})}},(0,r.__)("Add meta query","advanced-query-loop"))))},k=({attributes:e,setAttributes:t})=>{const{query:{date_query:{relation:a="",date_primary:o=new Date,date_secondary:n=new Date,inclusive:d=!1,range:s=""}={}}={}}=e;return(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null,(0,r.__)("Post Date Query","advanced-query-loop")),(0,l.createElement)(u.SelectControl,{label:(0,r.__)("Dynamic Range","advanced-query-loop"),help:(0,r.__)("Show posts from the last month, 3 months, 6 months, or 12 months. Posts are shown from the 1st of the month.","advanced-query-loop"),value:s,disabled:""!==a,options:[{label:(0,r.__)("None","advanced-query-loop"),value:""},{label:(0,r.__)("Last month","advanced-query-loop"),value:"last-month"},{label:(0,r.__)("Last 3 months","advanced-query-loop"),value:"three-months"},{label:(0,r.__)("Last 6 months","advanced-query-loop"),value:"six-months"},{label:(0,r.__)("Last 12 months","advanced-query-loop"),value:"twelve-months"}],onChange:a=>{t({query:{...e.query,date_query:{...e.query.date_query,range:a}}})}}),(0,l.createElement)(u.SelectControl,{label:(0,r.__)("Date Relationship","advanced-query-loop"),help:(0,r.__)("Show posts before, after, or between the selected date(s).","advanced-query-loop"),value:a,disabled:""!==s,options:[{label:(0,r.__)("None","advanced-query-loop"),value:""},{label:(0,r.__)("Before","advanced-query-loop"),value:"before"},{label:(0,r.__)("After","advanced-query-loop"),value:"after"},{label:(0,r.__)("Between","advanced-query-loop"),value:"between"}],onChange:a=>{t({query:{...e.query,date_query:""!==a?{...e.query.date_query,relation:a}:""}})}}),""!==a&&(0,l.createElement)(l.Fragment,null,"between"===a&&(0,l.createElement)("h4",null,(0,r.__)("Start date","advanced-query-loop")),(0,l.createElement)(u.DatePicker,{currentDate:o,onChange:a=>{t({query:{...e.query,date_query:{...e.query.date_query,date_primary:a}}})}}),"between"===a&&(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h4",null,(0,r.__)("End date","advanced-query-loop")),(0,l.createElement)(u.DatePicker,{currentDate:n,onChange:a=>{t({query:{...e.query,date_query:{...e.query.date_query,date_secondary:a}}})}})),(0,l.createElement)("br",null),(0,l.createElement)(u.CheckboxControl,{label:(0,r.__)("Include selected date(s)","advanced-query-loop"),help:(0,r.__)("Should the selected date(s) be included in your query?","advanced-query-loop"),checked:d,onChange:a=>{t({query:{...e.query,date_query:{...e.query.date_query,inclusive:a}}})}})))},x=window.wp.data,F=({attributes:e,setAttributes:t})=>{const{query:{multiple_posts:a=[],postType:o}={}}=e,n=(0,x.useSelect)((e=>e(C.store).getPostTypes({per_page:50})?.filter((({viewable:e})=>e))?.map((({slug:e})=>e))));return n?(0,l.createElement)(u.BaseControl,{help:(0,r.__)("These post types will be queried in addition to the main post type.","advanced-query-loop")},(0,l.createElement)(u.FormTokenField,{label:(0,r.__)("Additional Post Types","advanced-query-loop"),value:[...a.filter((e=>e!==o))],suggestions:[...n?.filter((e=>e!==o))],onChange:a=>{t({query:{...e.query,multiple_posts:a||[]}})},__experimentalExpandOnFocus:!0,__experimentalShowHowTo:!1})):(0,l.createElement)("div",null,(0,r.__)("Loading…","advanced-query-loop"))},L=[{label:(0,r.__)("Name","advanced-query-loop"),value:"name"},{label:(0,r.__)("Author","advanced-query-loop"),value:"author"},{label:(0,r.__)("Comment Count","advanced-query-loop"),value:"comment_count"},{label:(0,r.__)("Date","advanced-query-loop"),value:"date"},{label:(0,r.__)("Included Posts","advanced-query-loop"),value:"post__in"},{label:(0,r.__)("Last Modified Date","advanced-query-loop"),value:"modified"},{label:(0,r.__)("Menu Order","advanced-query-loop"),value:"menu_order"},{label:(0,r.__)("Meta Value","advanced-query-loop"),value:"meta_value"},{label:(0,r.__)("Meta Value Num","advanced-query-loop"),value:"meta_value_num"},{label:(0,r.__)("Post ID","advanced-query-loop"),value:"id"},{label:(0,r.__)("Random","advanced-query-loop"),value:"rand"},{label:(0,r.__)("Title","advanced-query-loop"),value:"title"}],B=({attributes:e,setAttributes:t})=>{const{query:{order:a,orderBy:o}={}}=e;return(0,l.createElement)(l.Fragment,null,(0,l.createElement)(u.SelectControl,{label:(0,r.__)("Post Order By","advanced-query-loop"),value:o,help:"meta_value"===o||"meta_value_num"===o?(0,r.__)("Meta Value and Meta Value Num require that Meta Key is set in the Meta Query section.","advanced-query-loop"):"",options:L.sort(((e,t)=>e.label.localeCompare(t.label))),onChange:a=>{t({query:{...e.query,orderBy:a}})}}),(0,l.createElement)(u.ToggleControl,{label:(0,r.__)("Ascending Order","advanced-query-loop"),checked:"asc"===a,onChange:()=>{t({query:{...e.query,order:"asc"===a?"desc":"asc"}})}}))},D=({attributes:e,setAttributes:t})=>{const{query:{exclude_current:a}={}}=e,{record:o}=(0,C.useEntityRecord)("root","site"),n=(0,x.useSelect)((e=>e("core/editor").getCurrentPost()),[]);if(!n)return(0,l.createElement)("div",null,(0,r.__)("Loading…","advanced-query-loop"));const d=()=>{const{show_on_front:e}=o,t=["archive","search",..."posts"===e?["home","front-page"]:[]];return"wp_template"===n.type&&t.includes(n.slug)};return(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null," ",(0,r.__)("Exclude Posts","advanced-query-loop")),(0,l.createElement)(u.ToggleControl,{label:(0,r.__)("Exclude Current Post","advanced-query-loop"),checked:!!a,disabled:d(),onChange:a=>{t({query:{...e.query,exclude_current:a?n.id:0}})},help:d()?(0,r.__)("This option is disabled for this template as there is no dedicated post to exclude.","advanced-query-loop"):(0,r.__)("Remove the associated post for this template/content from the query results.","advanced-query-loop")}))},I=({attributes:e,setAttributes:t})=>{const{query:{include_posts:a=[],postType:o,multiple_posts:n=[],exclude_current:d=0}={}}=e,[s,c]=(0,S.useState)(""),[i,y]=(0,S.useState)(n),m=(0,x.useSelect)((e=>{const{getEntityRecords:t}=e("core");return[...n,o].reduce(((e,a)=>[...e,...t("postType",a,{per_page:10,search:s,exclude:d?[d]:[]})||[]]),[])}),[o,n,d,s]);return(0,S.useEffect)((()=>{JSON.stringify(n)!==JSON.stringify(i)&&(t({query:{...e.query,include_posts:[]}}),y(n))}),[n]),m?(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null," ",(0,r.__)("Include Posts","advanced-query-loop")),(0,l.createElement)(u.BaseControl,{help:(0,r.__)("Start typing to search for a post title or manually enter one.","advanced-query-loop")},(0,l.createElement)(u.FormTokenField,{label:(0,r.__)("Posts","advanced-query-loop"),value:a.map((e=>e.title)),suggestions:m.map((e=>e.title.rendered)),onInputChange:e=>c(e),onChange:r=>{t({query:{...e.query,include_posts:r.map((e=>(e=>{const t=a.find((t=>t.title===e))||m.find((t=>t.title.rendered===e));return t.title.rendered?{id:t.id,title:t.title.rendered}:t})(e)))||[]}}),c("")},__experimentalExpandOnFocus:!0,__experimentalShowHowTo:!1}))):(0,l.createElement)("div",null,(0,r.__)("Loading…","advanced-query-loop"))};(0,o.addFilter)("editor.BlockEdit","aql/add-add-controls/core/query",(e=>t=>{if((e=>{const{attributes:{namespace:t}}=e;return t&&t===O})(t)){const{attributes:a}=t;return!1===a.query.inherit?(0,l.createElement)(l.Fragment,null,(0,l.createElement)(e,{...t}),(0,l.createElement)(n.InspectorControls,null,(0,l.createElement)(u.PanelBody,{title:(0,r.__)("Advanced Query Settings","advanced-query-loop")},(0,l.createElement)(F,{...t}),(0,l.createElement)(q,{...t}),(0,l.createElement)(v,{...t}),(0,l.createElement)(B,{...t}),(0,l.createElement)(D,{...t}),(0,l.createElement)(I,{...t}),(0,l.createElement)(T,{...t}),(0,l.createElement)(k,{...t}),(0,l.createElement)(i.Slot,{fillProps:{...t}})))):(0,l.createElement)(l.Fragment,null,(0,l.createElement)(e,{...t}),(0,l.createElement)(n.InspectorControls,null,(0,l.createElement)(u.PanelBody,{title:(0,r.__)("Advanced Query Settings","advanced-query-loop")},(0,l.createElement)(B,{...t}),(0,l.createElement)(_.Slot,{fillProps:{...t}}))))}return(0,l.createElement)(e,{...t})})),(0,o.addFilter)("blocks.registerBlockType","aql/add-transforms/query-block",(function(e,t){return"core/query"!==t?e:{...e,keywords:[...e.keywords,"AQL","aql"],transforms:{to:e?.transforms?.to||[],from:[...e?.transforms?.from||[],{type:"enter",regExp:/^(AQL|aql)$/,transform:()=>(0,a.createBlock)("core/query",{namespace:"advanced-query-loop"},[])}]}}}));const O="advanced-query-loop";(0,a.registerBlockVariation)("core/query",{name:O,title:(0,r.__)("Advanced Query Loop","advanced-query-loop"),description:(0,r.__)("Create advanced queries","advanced-query-loop"),icon:function(){return(0,l.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 221.3 111.6"},(0,l.createElement)("text",{fill:"#e76f51",fontFamily:"Montserrat-Bold, Montserrat",fontSize:"100",transform:"translate(.9 85)"},(0,l.createElement)("tspan",{x:"0",y:"0",letterSpacing:"0em"},"A"),(0,l.createElement)("tspan",{x:"75.6",y:"0",letterSpacing:"0em"},"QL")))},isActive:["namespace"],attributes:{namespace:O},scope:["inserter","transform"]}),aql=t})();