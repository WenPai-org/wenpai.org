var aql;(()=>{"use strict";var e={d:(t,r)=>{for(var a in r)e.o(r,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{AQL:()=>B,AQLControls:()=>i,AQLControlsInheritedQuery:()=>_});const r=window.wp.blocks,a=window.wp.i18n,n=window.React,l=window.wp.hooks,o=window.wp.blockEditor,u=window.wp.components,{Fill:d,Slot:c}=(0,u.createSlotFill)("AQLControls"),s=({children:e})=>(0,n.createElement)(d,null,e);s.Slot=({fillProps:e})=>(0,n.createElement)(c,{fillProps:e},(e=>e.length?e:null));const i=s,{Fill:y,Slot:m}=(0,u.createSlotFill)("AQLControlsInheritedQuery"),p=({children:e})=>(0,n.createElement)(y,null,e);p.Slot=m;const _=p,q=({attributes:e,setAttributes:t})=>{const{query:{perPage:r,offset:l=0}={}}=e;return(0,n.createElement)(u.RangeControl,{label:(0,a.__)("Posts Per Page","advanced-query-loop"),min:1,max:50,onChange:r=>{t({query:{...e.query,perPage:r,offset:l}})},value:r})},v=({attributes:e,setAttributes:t})=>{const{query:{offset:r=0}={}}=e;return(0,n.createElement)(u.__experimentalNumberControl,{label:(0,a.__)("Post Offset","advanced-query-loop"),value:r,min:0,onChange:r=>{t({query:{...e.query,offset:r}})}})},E={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let g;const b=new Uint8Array(16);function h(){if(!g&&(g="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!g))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return g(b)}const f=[];for(let e=0;e<256;++e)f.push((e+256).toString(16).slice(1));const w=function(e,t,r){if(E.randomUUID&&!t&&!e)return E.randomUUID();const a=(e=e||{}).random||(e.rng||h)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=a[e];return t}return function(e,t=0){return(f[e[t+0]]+f[e[t+1]]+f[e[t+2]]+f[e[t+3]]+"-"+f[e[t+4]]+f[e[t+5]]+"-"+f[e[t+6]]+f[e[t+7]]+"-"+f[e[t+8]]+f[e[t+9]]+"-"+f[e[t+10]]+f[e[t+11]]+f[e[t+12]]+f[e[t+13]]+f[e[t+14]]+f[e[t+15]]).toLowerCase()}(a)},C=window.wp.coreData,S=window.wp.element,P=["=","!=",">",">=","<","<=","LIKE","NOT LIKE","IN","NOT IN","BETWEEN","NOT BETWEEN","EXISTS","NOT EXISTS","REGEXP","NOT REGEXP","RLIKE"],T=({registeredMetaKeys:e,id:t,queries:r,attributes:l,setAttributes:o})=>{const d=r.find((e=>e.id===t)),c=(e,t,r,a)=>e.map((e=>e.id===t?{...e,[r]:a}:e));return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(u.BaseControl,{help:(0,a.__)("Start typing to search for a meta key or manually enter one.","advanced-query-loop")},(0,n.createElement)(u.FormTokenField,{label:(0,a.__)("Meta Key","advanced-query-loop"),value:d?.meta_key?.length?[d.meta_key]:[],__experimentalShowHowTo:!1,suggestions:e,maxLength:1,onChange:e=>{o({query:{...l.query,meta_query:{...l.query.meta_query,queries:c(r,t,"meta_key",e[0])}}})}})),(0,n.createElement)(u.TextControl,{label:(0,a.__)("Meta Value","advanced-query-loop"),value:d.meta_value,onChange:e=>{o({query:{...l.query,meta_query:{...l.query.meta_query,queries:c(r,t,"meta_value",e)}}})}}),(0,n.createElement)(u.SelectControl,{label:(0,a.__)("Meta Compare","advanced-query-loop"),value:d.meta_compare,options:[...P.map((e=>({label:e,value:e})))],onChange:e=>{o({query:{...l.query,meta_query:{...l.query.meta_query,queries:c(r,t,"meta_compare",e)}}})}}),(0,n.createElement)(u.Button,{isSmall:!0,variant:"secondary",isDestructive:!0,onClick:()=>{const e=r.filter((e=>e.id!==t));o({query:{...l.query,meta_query:{...l.query.meta_query,queries:e}}})}},(0,a.__)("Remove meta query","advanced-query-loop")))},A=({attributes:e,setAttributes:t})=>{const{query:{postType:r,meta_query:{relation:l="",queries:o=[]}={}}={}}=e,{records:d}=(0,C.useEntityRecords)("postType",r,{per_page:1}),[c]=(0,S.useState)(r),s=(e=>({...e?.[0]?.meta,...e?.[0]?.acf}))(d);return(0,S.useEffect)((()=>{r!==c&&t({query:{...e.query,include_posts:[],meta_query:{}}})}),[r]),(0,n.createElement)(n.Fragment,null,(0,n.createElement)("h2",null,(0,a.__)("Post Meta Query","advanced-query-loop")),(0,n.createElement)(n.Fragment,null,o.length>1&&(0,n.createElement)(u.SelectControl,{label:(0,a.__)("Query Relationship","advanced-query-loop"),value:l,options:[{label:"Choose relationship",value:""},{label:"AND",value:"AND"},{label:"OR",value:"OR"}],onChange:r=>t({query:{...e.query,meta_query:{...e.query.meta_query,relation:r}}})}),o.length<1&&(0,n.createElement)("p",null,(0,a.__)("Add a meta query to select post meta to query","advanced-query-loop")),o.map((({id:r,meta_key:a,meta_value:l,compare:d})=>(0,n.createElement)(u.PanelBody,{key:r},(0,n.createElement)(T,{id:r,metaKey:a,metaValue:l,metaCompare:d,registeredMetaKeys:Object.keys(s),queries:o,attributes:e,setAttributes:t})))),(0,n.createElement)(u.Button,{isSmall:!0,variant:"primary",onClick:()=>{const r=[...o,{id:w(),meta_key:"",meta_value:"",meta_compare:""}];t({query:{...e.query,meta_query:{...e.query.meta_query,queries:r}}})}},(0,a.__)("Add meta query","advanced-query-loop"))))},F=({attributes:e,setAttributes:t})=>{const{query:{date_query:{relation:r="",date_primary:l=new Date,date_secondary:o=new Date,inclusive:d=!1}={}}={}}=e;return(0,n.createElement)(n.Fragment,null,(0,n.createElement)("h2",null,(0,a.__)("Post Date Query","advanced-query-loop")),(0,n.createElement)(u.SelectControl,{label:(0,a.__)("Date Relationship","advanced-query-loop"),value:r,options:[{label:"None",value:""},{label:"Before",value:"before"},{label:"After",value:"after"},{label:"Between",value:"between"}],onChange:r=>{t({query:{...e.query,date_query:""!==r?{...e.query.date_query,relation:r}:""}})}}),""!==r&&(0,n.createElement)(n.Fragment,null,"between"===r&&(0,n.createElement)("h4",null,(0,a.__)("Start date","advanced-query-loop")),(0,n.createElement)(u.DatePicker,{currentDate:l,onChange:r=>{t({query:{...e.query,date_query:{...e.query.date_query,date_primary:r}}})}}),"between"===r&&(0,n.createElement)(n.Fragment,null,(0,n.createElement)("h4",null,(0,a.__)("End date","advanced-query-loop")),(0,n.createElement)(u.DatePicker,{currentDate:o,onChange:r=>{t({query:{...e.query,date_query:{...e.query.date_query,date_secondary:r}}})}})),(0,n.createElement)("br",null),(0,n.createElement)(u.CheckboxControl,{label:(0,a.__)("Include selected date(s)","advanced-query-loop"),help:(0,a.__)("Should the selected date(s) be included in your query?","advanced-query-loop"),checked:d,onChange:r=>{t({query:{...e.query,date_query:{...e.query.date_query,inclusive:r}}})}})))},k=window.wp.data,x=({attributes:e,setAttributes:t})=>{const{query:{multiple_posts:r=[],postType:l}={}}=e,o=(0,k.useSelect)((e=>e(C.store).getPostTypes({per_page:50})?.filter((({viewable:e})=>e))?.map((({slug:e})=>e))));return o?(0,n.createElement)(u.BaseControl,{help:(0,a.__)("These post types will be queried in addition to the main post type.","advanced-query-loop")},(0,n.createElement)(u.FormTokenField,{label:(0,a.__)("Additional Post Types","advanced-query-loop"),value:[...r.filter((e=>e!==l))],suggestions:[...o?.filter((e=>e!==l))],onChange:r=>{t({query:{...e.query,multiple_posts:r||[]}})},__experimentalExpandOnFocus:!0,__experimentalShowHowTo:!1})):(0,n.createElement)("div",null,(0,a.__)("Loading…","advanced-query-loop"))},I=({attributes:e,setAttributes:t})=>{const{query:{order:r,orderBy:l}={}}=e;return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(u.SelectControl,{label:(0,a.__)("Post Order By","advanced-query-loop"),value:l,help:"meta_value"===l||"meta_value_num"===l?(0,a.__)("Meta Value and Meta Value Num require that Meta Key is set in the Meta Query section.","advanced-query-loop"):"",options:[{label:(0,a.__)("Author","advanced-query-loop"),value:"author"},{label:(0,a.__)("Comment Count","advanced-query-loop"),value:"comment_count"},{label:(0,a.__)("Date","advanced-query-loop"),value:"date"},{label:(0,a.__)("Included Posts","advanced-query-loop"),value:"post__in"},{label:(0,a.__)("Last Modified Date","advanced-query-loop"),value:"modified"},{label:(0,a.__)("Menu Order","advanced-query-loop"),value:"menu_order"},{label:(0,a.__)("Meta Value","advanced-query-loop"),value:"meta_value"},{label:(0,a.__)("Meta Value Num","advanced-query-loop"),value:"meta_value_num"},{label:(0,a.__)("Post ID","advanced-query-loop"),value:"id"},{label:(0,a.__)("Random","advanced-query-loop"),value:"rand"},{label:(0,a.__)("Title","advanced-query-loop"),value:"title"}],onChange:r=>{t({query:{...e.query,orderBy:r}})}}),(0,n.createElement)(u.ToggleControl,{label:(0,a.__)("Ascending Order","advanced-query-loop"),checked:"asc"===r,onChange:()=>{t({query:{...e.query,order:"asc"===r?"desc":"asc"}})}}))},O=({attributes:e,setAttributes:t})=>{const{query:{exclude_current:r}={}}=e,{record:l}=(0,C.useEntityRecord)("root","site"),o=(0,k.useSelect)((e=>e("core/editor").getCurrentPost()),[]);if(!o)return(0,n.createElement)("div",null,(0,a.__)("Loading…","advanced-query-loop"));const d=()=>{const{show_on_front:e}=l,t=["archive","search",..."posts"===e?["home","front-page"]:[]];return"wp_template"===o.type&&t.includes(o.slug)};return(0,n.createElement)(n.Fragment,null,(0,n.createElement)("h2",null," ",(0,a.__)("Exclude Posts","advanced-query-loop")),(0,n.createElement)(u.ToggleControl,{label:(0,a.__)("Exclude Current Post","advanced-query-loop"),checked:!!r,disabled:d(),onChange:r=>{t({query:{...e.query,exclude_current:r?o.id:0}})},help:d()?(0,a.__)("This option is disabled for this template as there is no dedicated post to exclude.","advanced-query-loop"):(0,a.__)("Remove the associated post for this template/content from the query results.","advanced-query-loop")}))},D=({attributes:e,setAttributes:t})=>{const{query:{include_posts:r=[],postType:l,multiple_posts:o=[],exclude_current:d=0}={}}=e,[c,s]=(0,S.useState)(""),[i,y]=(0,S.useState)(o),m=(0,k.useSelect)((e=>{const{getEntityRecords:t}=e("core");return[...o,l].reduce(((e,r)=>[...e,...t("postType",r,{per_page:10,search:c,exclude:d?[d]:[]})||[]]),[])}),[l,o,d,c]);return(0,S.useEffect)((()=>{JSON.stringify(o)!==JSON.stringify(i)&&(t({query:{...e.query,include_posts:[]}}),y(o))}),[o]),m?(0,n.createElement)(n.Fragment,null,(0,n.createElement)("h2",null," ",(0,a.__)("Include Posts","advanced-query-loop")),(0,n.createElement)(u.BaseControl,{help:(0,a.__)("Start typing to search for a post title or manually enter one.","advanced-query-loop")},(0,n.createElement)(u.FormTokenField,{label:(0,a.__)("Posts","advanced-query-loop"),value:r.map((e=>e.title)),suggestions:m.map((e=>e.title.rendered)),onInputChange:e=>s(e),onChange:a=>{t({query:{...e.query,include_posts:a.map((e=>(e=>{const t=r.find((t=>t.title===e))||m.find((t=>t.title.rendered===e));return t.title.rendered?{id:t.id,title:t.title.rendered}:t})(e)))||[]}}),s("")},__experimentalExpandOnFocus:!0,__experimentalShowHowTo:!1}))):(0,n.createElement)("div",null,(0,a.__)("Loading…","advanced-query-loop"))};(0,l.addFilter)("editor.BlockEdit","core/query",(e=>t=>{if((e=>{const{attributes:{namespace:t}}=e;return t&&t===B})(t)){const{attributes:r}=t;return!1===r.query.inherit?(0,n.createElement)(n.Fragment,null,(0,n.createElement)(e,{...t}),(0,n.createElement)(o.InspectorControls,null,(0,n.createElement)(u.PanelBody,{title:(0,a.__)("Advanced Query Settings","advanced-query-loop")},(0,n.createElement)(x,{...t}),(0,n.createElement)(q,{...t}),(0,n.createElement)(v,{...t}),(0,n.createElement)(I,{...t}),(0,n.createElement)(O,{...t}),(0,n.createElement)(D,{...t}),(0,n.createElement)(A,{...t}),(0,n.createElement)(F,{...t}),(0,n.createElement)(i.Slot,{fillProps:{...t}})))):(0,n.createElement)(n.Fragment,null,(0,n.createElement)(e,{...t}),(0,n.createElement)(o.InspectorControls,null,(0,n.createElement)(u.PanelBody,{title:(0,a.__)("Advanced Query Settings","advanced-query-loop")},(0,n.createElement)(I,{...t}),(0,n.createElement)(_.Slot,{fillProps:{...t}}))))}return(0,n.createElement)(e,{...t})}));const B="advanced-query-loop";(0,r.registerBlockVariation)("core/query",{name:B,title:(0,a.__)("Advanced Query Loop","advanced-query-loop"),description:(0,a.__)("Create advanced queries","advanced-query-loop"),icon:function(){return(0,n.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 221.3 111.6"},(0,n.createElement)("text",{fill:"#e76f51",fontFamily:"Montserrat-Bold, Montserrat",fontSize:"100",transform:"translate(.9 85)"},(0,n.createElement)("tspan",{x:"0",y:"0",letterSpacing:"0em"},"A"),(0,n.createElement)("tspan",{x:"75.6",y:"0",letterSpacing:"0em"},"QL")))},isActive:["namespace"],attributes:{namespace:B},scope:["inserter","transform"]}),aql=t})();