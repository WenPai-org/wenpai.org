var aql;(()=>{"use strict";var e={d:(t,a)=>{for(var r in a)e.o(a,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{AQL:()=>M,AQLControls:()=>i,AQLControlsInheritedQuery:()=>_});const a=window.wp.blocks,r=window.wp.i18n,l=window.React,n=window.wp.hooks,o=window.wp.blockEditor,u=window.wp.components,{Fill:d,Slot:c}=(0,u.createSlotFill)("AQLControls"),s=({children:e})=>(0,l.createElement)(d,null,e);s.Slot=({fillProps:e})=>(0,l.createElement)(c,{fillProps:e},(e=>e.length?e:null));const i=s,{Fill:y,Slot:m}=(0,u.createSlotFill)("AQLControlsInheritedQuery"),p=({children:e})=>(0,l.createElement)(y,null,e);p.Slot=m;const _=p,q=({attributes:e,setAttributes:t})=>{const{query:{perPage:a,offset:n=0}={}}=e;return(0,l.createElement)(u.RangeControl,{label:(0,r.__)("Posts Per Page","advanced-query-loop"),min:1,max:50,onChange:a=>{t({query:{...e.query,perPage:a,offset:n}})},value:a})},v=({attributes:e,setAttributes:t})=>{const{query:{offset:a=0}={}}=e;return(0,l.createElement)(u.__experimentalNumberControl,{label:(0,r.__)("Post Offset","advanced-query-loop"),value:a,min:0,onChange:a=>{t({query:{...e.query,offset:a}})}})},h={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let E;const b=new Uint8Array(16);function g(){if(!E&&(E="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!E))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return E(b)}const f=[];for(let e=0;e<256;++e)f.push((e+256).toString(16).slice(1));const w=function(e,t,a){if(h.randomUUID&&!t&&!e)return h.randomUUID();const r=(e=e||{}).random||(e.rng||g)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){a=a||0;for(let e=0;e<16;++e)t[a+e]=r[e];return t}return function(e,t=0){return(f[e[t+0]]+f[e[t+1]]+f[e[t+2]]+f[e[t+3]]+"-"+f[e[t+4]]+f[e[t+5]]+"-"+f[e[t+6]]+f[e[t+7]]+"-"+f[e[t+8]]+f[e[t+9]]+"-"+f[e[t+10]]+f[e[t+11]]+f[e[t+12]]+f[e[t+13]]+f[e[t+14]]+f[e[t+15]]).toLowerCase()}(r)},C=window.wp.coreData,S=window.wp.element,P=["=","!=",">",">=","<","<=","LIKE","NOT LIKE","IN","NOT IN","BETWEEN","NOT BETWEEN","EXISTS","NOT EXISTS","REGEXP","NOT REGEXP","RLIKE"],k=({registeredMetaKeys:e,id:t,queries:a,attributes:n,setAttributes:o})=>{const d=a.find((e=>e.id===t)),c=(e,t,a,r)=>e.map((e=>e.id===t?{...e,[a]:r}:e));return(0,l.createElement)(l.Fragment,null,(0,l.createElement)(u.BaseControl,{help:(0,r.__)("Start typing to search for a meta key or manually enter one.","advanced-query-loop")},(0,l.createElement)(u.FormTokenField,{label:(0,r.__)("Meta Key","advanced-query-loop"),value:d?.meta_key?.length?[d.meta_key]:[],__experimentalShowHowTo:!1,suggestions:e,maxLength:1,onChange:e=>{o({query:{...n.query,meta_query:{...n.query.meta_query,queries:c(a,t,"meta_key",e[0])}}})}})),(0,l.createElement)(u.TextControl,{label:(0,r.__)("Meta Value","advanced-query-loop"),value:d.meta_value,onChange:e=>{o({query:{...n.query,meta_query:{...n.query.meta_query,queries:c(a,t,"meta_value",e)}}})}}),(0,l.createElement)(u.SelectControl,{label:(0,r.__)("Meta Compare","advanced-query-loop"),value:d.meta_compare,options:[...P.map((e=>({label:e,value:e})))],onChange:e=>{o({query:{...n.query,meta_query:{...n.query.meta_query,queries:c(a,t,"meta_compare",e)}}})}}),(0,l.createElement)(u.Button,{isSmall:!0,variant:"secondary",isDestructive:!0,onClick:()=>{const e=a.filter((e=>e.id!==t));o({query:{...n.query,meta_query:{...n.query.meta_query,queries:e}}})}},(0,r.__)("Remove meta query","advanced-query-loop")))},T=({attributes:e,setAttributes:t})=>{const{query:{postType:a,meta_query:{relation:n="",queries:o=[]}={}}={}}=e,{records:d}=(0,C.useEntityRecords)("postType",a,{per_page:1}),[c]=(0,S.useState)(a),s=(e=>({...e?.[0]?.meta,...e?.[0]?.acf}))(d);return(0,S.useEffect)((()=>{a!==c&&t({query:{...e.query,include_posts:[],meta_query:{}}})}),[a]),(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null,(0,r.__)("Post Meta Query","advanced-query-loop")),(0,l.createElement)(l.Fragment,null,o.length>1&&(0,l.createElement)(u.SelectControl,{label:(0,r.__)("Query Relationship","advanced-query-loop"),value:n,options:[{label:"Choose relationship",value:""},{label:"AND",value:"AND"},{label:"OR",value:"OR"}],onChange:a=>t({query:{...e.query,meta_query:{...e.query.meta_query,relation:a}}})}),o.length<1&&(0,l.createElement)("p",null,(0,r.__)("Add a meta query to select post meta to query","advanced-query-loop")),o.map((({id:a,meta_key:r,meta_value:n,compare:d})=>(0,l.createElement)(u.PanelBody,{key:a},(0,l.createElement)(k,{id:a,metaKey:r,metaValue:n,metaCompare:d,registeredMetaKeys:Object.keys(s),queries:o,attributes:e,setAttributes:t})))),(0,l.createElement)(u.Button,{isSmall:!0,variant:"primary",onClick:()=>{const a=[...o,{id:w(),meta_key:"",meta_value:"",meta_compare:""}];t({query:{...e.query,meta_query:{...e.query.meta_query,queries:a}}})}},(0,r.__)("Add meta query","advanced-query-loop"))))},A=({attributes:e,setAttributes:t})=>{const{query:{date_query:{relation:a="",date_primary:n=new Date,date_secondary:o=new Date,inclusive:d=!1,range:c="",current_date_in_range:s=!1}={}}={}}=e;return(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null,(0,r.__)("Post Date Query","advanced-query-loop")),(0,l.createElement)(u.SelectControl,{label:(0,r.__)("Dynamic Range","advanced-query-loop"),help:(0,r.__)("Show posts from the last month, 3 months, 6 months, or 12 months. Posts are shown from the 1st of the month.","advanced-query-loop"),value:c,disabled:""!==a,options:[{label:(0,r.__)("None","advanced-query-loop"),value:""},{label:(0,r.__)("Last month","advanced-query-loop"),value:"last-month"},{label:(0,r.__)("Last 3 months","advanced-query-loop"),value:"three-months"},{label:(0,r.__)("Last 6 months","advanced-query-loop"),value:"six-months"},{label:(0,r.__)("Last 12 months","advanced-query-loop"),value:"twelve-months"}],onChange:a=>{t({query:{...e.query,date_query:{...e.query.date_query,range:a}}})}}),""!==c&&(0,l.createElement)(u.CheckboxControl,{label:(0,r.__)("Include up to current date","advanced-query-loop"),help:(0,r.__)("Should the dynamic range include up to the current date?","advanced-query-loop"),disabled:""===c,checked:s,onChange:a=>{t({query:{...e.query,date_query:{...e.query.date_query,current_date_in_range:a}}})}}),(0,l.createElement)(u.SelectControl,{label:(0,r.__)("Date Relationship","advanced-query-loop"),help:(0,r.__)("Show posts before, after, or between the selected date(s).","advanced-query-loop"),value:a,disabled:""!==c,options:[{label:(0,r.__)("None","advanced-query-loop"),value:""},{label:(0,r.__)("Before","advanced-query-loop"),value:"before"},{label:(0,r.__)("After","advanced-query-loop"),value:"after"},{label:(0,r.__)("Between","advanced-query-loop"),value:"between"}],onChange:a=>{t({query:{...e.query,date_query:""!==a?{...e.query.date_query,relation:a}:""}})}}),""!==a&&(0,l.createElement)(l.Fragment,null,"between"===a&&(0,l.createElement)("h4",null,(0,r.__)("Start date","advanced-query-loop")),(0,l.createElement)(u.DatePicker,{currentDate:n,onChange:a=>{t({query:{...e.query,date_query:{...e.query.date_query,date_primary:a}}})}}),"between"===a&&(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h4",null,(0,r.__)("End date","advanced-query-loop")),(0,l.createElement)(u.DatePicker,{currentDate:o,onChange:a=>{t({query:{...e.query,date_query:{...e.query.date_query,date_secondary:a}}})}})),(0,l.createElement)("br",null),(0,l.createElement)(u.CheckboxControl,{label:(0,r.__)("Include selected date(s)","advanced-query-loop"),help:(0,r.__)("Should the selected date(s) be included in your query?","advanced-query-loop"),checked:d,onChange:a=>{t({query:{...e.query,date_query:{...e.query.date_query,inclusive:a}}})}})))},F=window.wp.data,x=({attributes:e,setAttributes:t})=>{const{query:{multiple_posts:a=[],postType:n}={}}=e,o=(0,F.useSelect)((e=>e(C.store).getPostTypes({per_page:50})?.filter((({viewable:e})=>e))?.map((({slug:e})=>e))));return o?(0,l.createElement)(u.BaseControl,{help:(0,r.__)("These post types will be queried in addition to the main post type.","advanced-query-loop")},(0,l.createElement)(u.FormTokenField,{label:(0,r.__)("Additional Post Types","advanced-query-loop"),value:[...a.filter((e=>e!==n))],suggestions:[...o?.filter((e=>e!==n))],onChange:a=>{t({query:{...e.query,multiple_posts:a||[]}})},__experimentalExpandOnFocus:!0,__experimentalShowHowTo:!1})):(0,l.createElement)("div",null,(0,r.__)("Loading…","advanced-query-loop"))},D=[{label:(0,r.__)("Name","advanced-query-loop"),value:"name"},{label:(0,r.__)("Author","advanced-query-loop"),value:"author"},{label:(0,r.__)("Comment Count","advanced-query-loop"),value:"comment_count"},{label:(0,r.__)("Date","advanced-query-loop"),value:"date"},{label:(0,r.__)("Included Posts","advanced-query-loop"),value:"post__in"},{label:(0,r.__)("Last Modified Date","advanced-query-loop"),value:"modified"},{label:(0,r.__)("Menu Order","advanced-query-loop"),value:"menu_order"},{label:(0,r.__)("Meta Value","advanced-query-loop"),value:"meta_value"},{label:(0,r.__)("Meta Value Num","advanced-query-loop"),value:"meta_value_num"},{label:(0,r.__)("Post ID","advanced-query-loop"),value:"id"},{label:(0,r.__)("Random","advanced-query-loop"),value:"rand"},{label:(0,r.__)("Title","advanced-query-loop"),value:"title"}],I=({attributes:e,setAttributes:t})=>{const{query:{order:a,orderBy:n}={}}=e;return(0,l.createElement)(l.Fragment,null,(0,l.createElement)(u.SelectControl,{label:(0,r.__)("Post Order By","advanced-query-loop"),value:n,help:"meta_value"===n||"meta_value_num"===n?(0,r.__)("Meta Value and Meta Value Num require that Meta Key is set in the Meta Query section.","advanced-query-loop"):"",options:D.sort(((e,t)=>e.label.localeCompare(t.label))),onChange:a=>{t({query:{...e.query,orderBy:a}})}}),(0,l.createElement)(u.ToggleControl,{label:(0,r.__)("Ascending Order","advanced-query-loop"),checked:"asc"===a,onChange:()=>{t({query:{...e.query,order:"asc"===a?"desc":"asc"}})}}))},B=({attributes:e,setAttributes:t})=>{const{query:{exclude_current:a}={}}=e,{record:n}=(0,C.useEntityRecord)("root","site"),o=(0,F.useSelect)((e=>e("core/editor").getCurrentPost()),[]);if(!o)return(0,l.createElement)("div",null,(0,r.__)("Loading…","advanced-query-loop"));const d=()=>{const{show_on_front:e}=n,t=["archive","search",..."posts"===e?["home","front-page"]:[]];return"wp_template"===o.type&&t.includes(o.slug)};return(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null," ",(0,r.__)("Exclude Posts","advanced-query-loop")),(0,l.createElement)(u.ToggleControl,{label:(0,r.__)("Exclude Current Post","advanced-query-loop"),checked:!!a,disabled:d(),onChange:a=>{t({query:{...e.query,exclude_current:a?o.id:0}})},help:d()?(0,r.__)("This option is disabled for this template as there is no dedicated post to exclude.","advanced-query-loop"):(0,r.__)("Remove the associated post for this template/content from the query results.","advanced-query-loop")}))},L=({attributes:e,setAttributes:t})=>{const{query:{include_posts:a=[],postType:n,multiple_posts:o=[],exclude_current:d=0}={}}=e,[c,s]=(0,S.useState)(""),[i,y]=(0,S.useState)(o),m=(0,F.useSelect)((e=>{const{getEntityRecords:t}=e("core");return[...o,n].reduce(((e,a)=>[...e,...t("postType",a,{per_page:10,search:c,exclude:d?[d]:[]})||[]]),[])}),[n,o,d,c]);return(0,S.useEffect)((()=>{JSON.stringify(o)!==JSON.stringify(i)&&(t({query:{...e.query,include_posts:[]}}),y(o))}),[o]),m?(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null," ",(0,r.__)("Include Posts","advanced-query-loop")),(0,l.createElement)(u.BaseControl,{help:(0,r.__)("Start typing to search for a post title or manually enter one.","advanced-query-loop")},(0,l.createElement)(u.FormTokenField,{label:(0,r.__)("Posts","advanced-query-loop"),value:a.map((e=>e.title)),suggestions:m.map((e=>e.title.rendered)),onInputChange:e=>s(e),onChange:r=>{t({query:{...e.query,include_posts:r.map((e=>(e=>{const t=a.find((t=>t.title===e))||m.find((t=>t.title.rendered.trim()===e));return t.title.rendered?{id:t.id,title:t.title.rendered}:t})(e)))||[]}}),s("")},__experimentalExpandOnFocus:!0,__experimentalShowHowTo:!1}))):(0,l.createElement)("div",null,(0,r.__)("Loading…","advanced-query-loop"))};(0,n.addFilter)("editor.BlockEdit","aql/add-add-controls/core/query",(e=>t=>{if((e=>{const{attributes:{namespace:t}}=e;return t&&t===M})(t)){const{attributes:a}=t;return!1===a.query.inherit?(0,l.createElement)(l.Fragment,null,(0,l.createElement)(e,{...t}),(0,l.createElement)(o.InspectorControls,null,(0,l.createElement)(u.PanelBody,{title:(0,r.__)("Advanced Query Settings","advanced-query-loop")},(0,l.createElement)(x,{...t}),(0,l.createElement)(q,{...t}),(0,l.createElement)(v,{...t}),(0,l.createElement)(I,{...t}),(0,l.createElement)(B,{...t}),(0,l.createElement)(L,{...t}),(0,l.createElement)(T,{...t}),(0,l.createElement)(A,{...t}),(0,l.createElement)(i.Slot,{fillProps:{...t}})))):(0,l.createElement)(l.Fragment,null,(0,l.createElement)(e,{...t}),(0,l.createElement)(o.InspectorControls,null,(0,l.createElement)(u.PanelBody,{title:(0,r.__)("Advanced Query Settings","advanced-query-loop")},(0,l.createElement)(I,{...t}),(0,l.createElement)(_.Slot,{fillProps:{...t}}))))}return(0,l.createElement)(e,{...t})})),(0,n.addFilter)("blocks.registerBlockType","aql/add-transforms/query-block",(function(e,t){return"core/query"!==t?e:{...e,keywords:[...e.keywords,"AQL","aql"],transforms:{to:e?.transforms?.to||[],from:[...e?.transforms?.from||[],{type:"enter",regExp:/^(AQL|aql)$/,transform:()=>(0,a.createBlock)("core/query",{namespace:"advanced-query-loop"},[])}]}}}));const O=window.wp.primitives,M="advanced-query-loop";(0,a.registerBlockVariation)("core/query",{name:M,title:(0,r.__)("Advanced Query Loop","advanced-query-loop"),description:(0,r.__)("Create advanced queries","advanced-query-loop"),icon:function(){return(0,l.createElement)(O.SVG,{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",fill:"none",viewBox:"0 0 24 24"},(0,l.createElement)(O.Path,{fill:"#2D2B55",d:"M0 0h24v24H0V0z"}),(0,l.createElement)(O.Path,{fill:"#fff",d:"M17.936 8.438h1.217v6.125h2.867v1.093h-4.084V8.437zM10.364 12.047c0 .515.11.97.33 1.361.22.392.519.701.897.928.385.22.815.33 1.289.33.481 0 .907-.106 1.279-.32.371-.22.663-.522.876-.907.213-.385.32-.825.32-1.32 0-.495-.107-.942-.32-1.34a2.455 2.455 0 00-.886-.95c-.372-.233-.812-.35-1.32-.35-.475 0-.898.11-1.269.33-.371.22-.663.526-.877.918-.213.385-.32.825-.32 1.32zm-1.29 0c0-.543.094-1.042.28-1.495.192-.454.456-.846.793-1.176a3.685 3.685 0 011.197-.784c.46-.185.955-.278 1.485-.278.543 0 1.041.093 1.495.278a3.57 3.57 0 011.186.784c.337.33.598.722.784 1.176.185.453.278.952.278 1.495 0 .536-.093 1.034-.278 1.495-.186.46-.447.86-.784 1.196-.33.337-.722.602-1.176.795a3.941 3.941 0 01-1.505.278 3.964 3.964 0 01-1.496-.278 3.676 3.676 0 01-1.196-.795 3.545 3.545 0 01-.784-1.196 3.964 3.964 0 01-.278-1.495zm3.425.515H13.9l3.248 3.146h-1.433l-3.217-3.146z"}),(0,l.createElement)(O.Path,{fill:"#E76F51",d:"M3.546 13.8l.227-1.031h3.351l.237 1.031H3.546zm1.887-3.32l-1.134 2.65-.021.268-1 2.258H1.906l3.527-7.62 3.527 7.62H7.588l-.98-2.196-.03-.3-1.145-2.68z"}))},isActive:["namespace"],attributes:{namespace:M},scope:["inserter","transform"]}),aql=t})();